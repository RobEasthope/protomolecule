name: Continuous Release

on:
  push:
    branches:
      - main

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: ðŸš€ Continuous Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write
      issues: read
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use PAT if available, otherwise GITHUB_TOKEN
          # PAT needs: repo scope for pushing to protected branches
          token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Monorepo
        uses: ./.github/actions/setup-monorepo

      - name: ðŸ” Validate Required Secrets
        run: |
          # Check for required secrets
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "âŒ Error: NPM_TOKEN secret is not configured"
            echo "Please add NPM_TOKEN to your repository secrets for publishing to NPM"
            exit 1
          fi
          echo "âœ… NPM_TOKEN is configured"
          
          # Check for optional PAT (warn if missing but don't fail)
          if [ -z "${{ secrets.RELEASE_PAT }}" ]; then
            echo "âš ï¸ Warning: RELEASE_PAT is not configured"
            echo "Using GITHUB_TOKEN - this may fail if branch protection rules are enabled"
          else
            echo "âœ… RELEASE_PAT is configured"
          fi

      - name: ðŸ—ï¸ Build packages
        run: |
          pnpm build
          
          # Verify build outputs for publishable packages
          if [ -f "packages/eslint-config/package.json" ]; then
            if [ ! -f "packages/eslint-config/dist/index.js" ]; then
              echo "âŒ Build failed: ESLint config dist/index.js not found"
              exit 1
            fi
          fi
          
          if [ -f "packages/tsconfig/package.json" ]; then
            PKG_PRIVATE=$(node -p "require('./packages/tsconfig/package.json').private")
            if [ "$PKG_PRIVATE" = "false" ]; then
              # Check for expected output files if tsconfig becomes public
              echo "âœ… TSConfig package build verified"
            fi
          fi
          
          echo "âœ… Build verification passed"

      - name: ðŸ“‹ Check for changesets
        id: changesets-check
        run: |
          # Check for changeset files, excluding README.md and config.json
          CHANGESET_COUNT=$(find .changeset -name "*.md" -not -name "README.md" 2>/dev/null | wc -l)
          
          if [ "$CHANGESET_COUNT" -gt 0 ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
            echo "Found $CHANGESET_COUNT changeset file(s) to process"
            # List the changesets for visibility
            find .changeset -name "*.md" -not -name "README.md" -exec basename {} \;
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "No changeset files found (excluding README.md)"
          fi

      - name: ðŸ”„ Configure Git
        if: steps.changesets-check.outputs.has_changesets == 'true'
        run: |
          # Configure git for commits
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸš€ Version and Publish to NPM
        if: steps.changesets-check.outputs.has_changesets == 'true'
        id: publish
        run: |
          # First, version packages based on changesets
          pnpm changeset version
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet && ! git diff --quiet; then
            # Stage all version changes
            git add -A
            
            # Try to publish packages
            set +e  # Don't exit on error
            PUBLISH_TEMP=$(mktemp publish-output-XXXXXX.txt)
            pnpm changeset publish > "$PUBLISH_TEMP" 2>&1
            PUBLISH_EXIT_CODE=$?
            mv "$PUBLISH_TEMP" publish-output.txt
            set -e  # Re-enable exit on error
            
            # Check if publish was successful
            if [ $PUBLISH_EXIT_CODE -eq 0 ] && grep -q "Publishing" publish-output.txt; then
              echo "published=true" >> $GITHUB_OUTPUT
              echo "publish_success=true" >> $GITHUB_OUTPUT
              cat publish-output.txt
              
              # Commit version changes only after successful publish
              git commit -m "chore: version packages [skip ci]"
              echo "version_committed=true" >> $GITHUB_OUTPUT
            else
              echo "published=false" >> $GITHUB_OUTPUT
              echo "publish_success=false" >> $GITHUB_OUTPUT
              echo "version_committed=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ NPM publish failed - rolling back version changes"
              cat publish-output.txt
              
              # Reset all changes since publish failed
              git reset --hard HEAD
            fi
          else
            echo "No version changes needed"
            echo "published=false" >> $GITHUB_OUTPUT
            echo "publish_success=false" >> $GITHUB_OUTPUT
            echo "version_committed=false" >> $GITHUB_OUTPUT
          fi
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          HUSKY: 0

      - name: ðŸ“ Push version commits
        if: steps.publish.outputs.version_committed == 'true'
        run: |
          # Retry logic for git push (up to 3 attempts with exponential backoff)
          MAX_ATTEMPTS=3
          ATTEMPT=1
          DELAY=2
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS to push version commits..."
            
            if git push origin main; then
              echo "âœ… Successfully pushed version commits"
              break
            else
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "âŒ Failed to push after $MAX_ATTEMPTS attempts"
                exit 1
              fi
              
              echo "âš ï¸ Push failed, retrying in ${DELAY} seconds..."
              sleep $DELAY
              DELAY=$((DELAY * 2))  # Exponential backoff
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done

      - name: ðŸ·ï¸ Create GitHub Release
        if: steps.publish.outputs.published == 'true'
        run: |
          # Extract published packages more reliably from changeset output
          # Look for lines like: ðŸ¦‹  @protomolecule/eslint-config@1.0.5
          PUBLISHED_PACKAGES=$(grep "ðŸ¦‹" publish-output.txt | sed 's/ðŸ¦‹  //' || echo "")
          
          if [ -z "$PUBLISHED_PACKAGES" ]; then
            # Fallback: try to parse Publishing lines
            PUBLISHED_PACKAGES=$(grep "Publishing" publish-output.txt | grep -oE "(@[^[:space:]]+@[0-9]+\.[0-9]+\.[0-9]+[^[:space:]]*|[^@[:space:]]+@[0-9]+\.[0-9]+\.[0-9]+[^[:space:]]*)" || echo "")
          fi
          
          # Determine version for release tag
          if [ -n "$PUBLISHED_PACKAGES" ]; then
            # Parse version from packages - use the highest version
            VERSION=$(echo "$PUBLISHED_PACKAGES" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9.]+)?" | sort -V | tail -1)
          else
            # Fallback to date-based version
            VERSION=$(date +"%Y.%m.%d")
          fi
          
          # Build simple release notes
          RELEASE_NOTES="## ðŸ“¦ Published Packages

$PUBLISHED_PACKAGES

---
*Automated release from continuous deployment workflow*"
          
          # Create GitHub release
          gh release create "v$VERSION" \
            --title "Release v$VERSION" \
            --notes "$RELEASE_NOTES" \
            --target main || {
              echo "âš ï¸ Release creation failed, but packages were published successfully"
              echo "Manual release can be created for version: v$VERSION"
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Generate Summary
        if: always()
        run: |
          echo "## ðŸš€ Continuous Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changesets-check.outputs.has_changesets }}" == "true" ]; then
            if [ "${{ steps.publish.outputs.publish_success }}" == "true" ]; then
              echo "âœ… Changesets processed and packages published successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Changesets processed but NPM publishing failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:** Check NPM_TOKEN and package configuration" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f publish-output.txt ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Publishing Output" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat publish-output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ No changesets found - no release needed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Workflow triggered by: ${{ github.actor }}_" >> $GITHUB_STEP_SUMMARY
