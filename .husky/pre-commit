#!/bin/sh

# Save list of staged files before formatting
git diff --cached --name-only > /tmp/staged_files.txt

# Format the code
pnpm format

# Re-add only the files that were originally staged and still exist
if [ -s /tmp/staged_files.txt ]; then
  files_formatted=false
  
  while IFS= read -r file; do
    # Check if file exists (not deleted) and was modified by formatting
    if [ -f "$file" ] && ! git diff --quiet -- "$file" 2>/dev/null; then
      git add -- "$file"
      files_formatted=true
    fi
  done < /tmp/staged_files.txt
  
  if [ "$files_formatted" = true ]; then
    echo "Code was formatted. Formatting changes added to commit."
  else
    echo "Code is already properly formatted."
  fi
else
  echo "No staged files to format."
fi

# Clean up
rm -f /tmp/staged_files.txt
